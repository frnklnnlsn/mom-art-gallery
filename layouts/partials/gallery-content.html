{{ define "head-styles" }}
<style>
    /* All the styles specific to the gallery page */
    #gallery-container { max-width: 900px; margin: 0 auto; padding: 20px; }
    #gallery-title-container { position: relative; display: flex; justify-content: center; margin-bottom: 20px; }
    .dropdown-button { background-color: #333; color: white; padding: 10px 20px; font-size: 20px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; min-width: 200px; text-align: center; }
    .dropdown-content { display: none; position: absolute; top: 100%; background-color: #f1f1f1; min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 6px; overflow: hidden; }
    .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; text-align: center; }
    .dropdown-content a:hover { background-color: #ddd; }
    .show { display: block; }
    #image-display { display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start; height: 520px; }
    
    #main-image-wrapper {
        flex: 3; display: flex; justify-content: center; align-items: center; height: 100%;
        background-color: #fdfdfd; border-radius: 4px; position: relative;
    }
    #main-image { max-width: 100%; max-height: 500px; border: 1px solid #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.1); object-fit: contain; cursor: pointer; }
    
    #fullscreen-btn {
        position: absolute; top: 10px; right: 10px; background-color: rgba(0, 0, 0, 0.5);
        color: white; border: none; border-radius: 4px; padding: 6px 10px;
        font-size: 14px; font-weight: bold;
        cursor: pointer; opacity: 0; transition: opacity 0.2s ease-in-out;
    }
    #main-image-wrapper:hover #fullscreen-btn { opacity: 1; }
    
    #fullscreen-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85); display: none; justify-content: center;
        align-items: center; z-index: 1000;
    }
    #fullscreen-image { max-width: 90%; max-height: 90%; object-fit: contain; }
    #close-fullscreen-btn { position: absolute; top: 20px; right: 40px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; }

    #image-info { flex: 1; padding: 0 15px; }
    #image-info h3 { margin-top: 0; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .info-item { margin-bottom: 10px; }
    .info-label { font-weight: bold; display: inline-block; min-width: 80px; }
    #thumbnail-container { width: 100%; max-width: 500px; margin: 20px auto; overflow: hidden; padding: 8px; background: #f8f8f8; border-radius: 6px; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); cursor: ew-resize; }
    #thumbnail-strip { display: flex; gap: 8px; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .thumbnail { width: 60px; height: 60px; object-fit: cover; border: 2px solid transparent; border-radius: 3px; cursor: pointer; opacity: 0.7; transition: all 0.2s ease; flex-shrink: 0; }
    .thumbnail:hover { opacity: 0.9; border-color: #ccc; }
    .thumbnail.active { opacity: 1; border-color: #333; transform: scale(1.05); }
    #controls { text-align: center; margin: 15px 0; }
    #controls button { padding: 0; margin: 0 5px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; width: 120px; height: 40px; font-size: 24px; display: inline-flex; justify-content: center; align-items: center; line-height: 1; }
    #controls button:hover { background: #555; }
</style>
{{ end }}

<div id="gallery-container">
  <div id="gallery-title-container">
    <button class="dropdown-button" id="category-button"></button>
    <div class="dropdown-content" id="category-dropdown"></div>
  </div>
  <div id="image-display">
    <div id="main-image-wrapper">
        <img id="main-image" src="" alt="Current artwork">
    </div>
    <div id="image-info">
      <h3>Image Details</h3>
      <div class="info-item"><span class="info-label">Title:</span> <span id="image-title"></span></div>
      <div class="info-item"><span class="info-label">Date:</span> <span id="image-date"></span></div>
      <div class="info-item"><span class="info-label">Description:</span> <span id="image-description"></span></div>
    </div>
  </div>
  <div id="thumbnail-container"><div id="thumbnail-strip"></div></div>
  <div id="controls"><button id="prev-btn">←</button><button id="next-btn">→</button></div>
</div>

<div id="fullscreen-overlay">
    <span id="close-fullscreen-btn">&times;</span>
    <img id="fullscreen-image" src="">
</div>


{{- $artworks := slice -}}
{{- $file := resources.Get "gallery.csv" -}}
{{- if $file -}}
  {{- $csvData := $file.Content | transform.Unmarshal (dict "delimiter" ",") -}}
  {{- range after 1 $csvData -}}
    {{- $artwork := dict "filename" (index . 0) "title" (index . 1) "date" (index . 2) "description" (index . 3) "category" (index . 4) -}}
    {{- $artworks = $artworks | append $artwork -}}
  {{- end -}}
{{- end -}}

<script>
    const artworks = {{ $artworks | jsonify | safeJS }};
    artworks.sort((a, b) => a.category.localeCompare(b.category));

    let currentIndex = 0;
    const savedIndex = sessionStorage.getItem('lastViewedImageIndex');
    if (savedIndex !== null && !isNaN(savedIndex) && parseInt(savedIndex, 10) < artworks.length) {
      currentIndex = parseInt(savedIndex, 10);
    }
    
    // Get all page elements
    const mainImageWrapper = document.getElementById('main-image-wrapper');
    const mainImage = document.getElementById('main-image');
    const imageTitleEl = document.getElementById('image-title');
    const imageDateEl = document.getElementById('image-date');
    const imageDescriptionEl = document.getElementById('image-description');
    const categoryButton = document.getElementById('category-button');
    const categoryDropdown = document.getElementById('category-dropdown');
    const thumbnailContainer = document.getElementById('thumbnail-container');
    const thumbnailStrip = document.getElementById('thumbnail-strip');
    const fullscreenOverlay = document.getElementById('fullscreen-overlay');
    const fullscreenImage = document.getElementById('fullscreen-image');
    const closeFullscreenBtn = document.getElementById('close-fullscreen-btn');
    let scrollPosition = 0;
    
    function initGallery() {
      if (!artworks || artworks.length === 0) {
        document.getElementById('gallery-container').style.display = 'none';
        return;
      }
      populateCategoryDropdown();
      createThumbnails();
      updateDisplay();
      setupEventListeners();
    }
    
    function updateDisplay() {
      const currentArt = artworks[currentIndex];
      sessionStorage.setItem('lastViewedImageIndex', currentIndex);

      let category = currentArt.category;
      let formattedCategory = category.charAt(0).toUpperCase() + category.slice(1).replace('-', ' ');
      categoryButton.textContent = formattedCategory;

      mainImage.src = `/gallery/${currentArt.filename}`;
      mainImage.alt = currentArt.title;
      imageTitleEl.textContent = currentArt.title;
      imageDateEl.textContent = currentArt.date;
      imageDescriptionEl.textContent = currentArt.description;

      if (!document.getElementById('fullscreen-btn')) {
        const fsBtn = document.createElement('button');
        fsBtn.id = 'fullscreen-btn';
        fsBtn.textContent = 'Full';
        fsBtn.title = 'View full screen';
        fsBtn.addEventListener('click', enterFullscreen);
        mainImageWrapper.appendChild(fsBtn);
      }

      updateActiveThumb();
      centerActiveThumbnail();
    }
    
    function enterFullscreen() {
        const currentArt = artworks[currentIndex];
        fullscreenImage.src = `/gallery/${currentArt.filename}`;
        fullscreenOverlay.style.display = 'flex';
    }

    function exitFullscreen() {
        fullscreenOverlay.style.display = 'none';
        fullscreenImage.src = '';
    }

    function populateCategoryDropdown() {
      const uniqueCategories = [...new Set(artworks.map(art => art.category))];
      categoryDropdown.innerHTML = '';
      uniqueCategories.forEach(category => {
        const link = document.createElement('a');
        link.href = "#";
        link.textContent = category.charAt(0).toUpperCase() + category.slice(1).replace('-', ' ');
        link.dataset.category = category;
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetCategory = e.target.dataset.category;
          const newIndex = artworks.findIndex(art => art.category === targetCategory);
          if (newIndex !== -1) {
            currentIndex = newIndex;
            updateDisplay();
          }
          categoryDropdown.classList.remove('show');
        });
        categoryDropdown.appendChild(link);
      });
    }

    function toggleDropdown() {
      categoryDropdown.classList.toggle('show');
    }

    function createThumbnails() {
      thumbnailStrip.innerHTML = '';
      artworks.forEach((art, index) => {
        const thumb = document.createElement('img');
        thumb.src = `/gallery/${art.filename}`;
        thumb.className = 'thumbnail';
        thumb.alt = `Thumbnail for ${art.title}`;
        thumb.addEventListener('click', () => {
          currentIndex = index;
          updateDisplay();
        });
        thumbnailStrip.appendChild(thumb);
      });
    }
    
    function updateActiveThumb() {
      document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
        thumb.classList.toggle('active', index === currentIndex);
      });
    }

    function centerActiveThumbnail() {
      const activeThumb = document.querySelector('.thumbnail.active');
      if (!activeThumb) return;

      const containerWidth = thumbnailContainer.clientWidth;
      const stripWidth = thumbnailStrip.scrollWidth;
      
      const thumbCenter = activeThumb.offsetLeft + (activeThumb.clientWidth / 2);
      
      let newScrollPosition = -(thumbCenter - (containerWidth / 2));
      
      const maxScroll = -(stripWidth - containerWidth);
      if (newScrollPosition > 0) newScrollPosition = 0;
      if (newScrollPosition < maxScroll) newScrollPosition = maxScroll;
      
      scrollPosition = newScrollPosition;
      thumbnailStrip.style.transform = `translateX(${scrollPosition}px)`;
    }

    function handleThumbnailScroll(event) {
      event.preventDefault();
      
      scrollPosition -= event.deltaY;
      
      const containerWidth = thumbnailContainer.clientWidth;
      const stripWidth = thumbnailStrip.scrollWidth;
      const maxScroll = -(stripWidth - containerWidth);
      if (scrollPosition > 0) scrollPosition = 0;
      if (scrollPosition < maxScroll) scrollPosition = maxScroll;
      
      thumbnailStrip.style.transform = `translateX(${scrollPosition}px)`;
    }
    
    function setupEventListeners() {
      // Dropdown listeners
      categoryButton.addEventListener('click', toggleDropdown);
      window.onclick = function(event) {
        if (!event.target.matches('.dropdown-button')) {
          if (categoryDropdown.classList.contains('show')) {
            categoryDropdown.classList.remove('show');
          }
        }
      }

      // Thumbnail listener
      thumbnailContainer.addEventListener('wheel', handleThumbnailScroll);
      
      // Controls listeners
      document.getElementById('prev-btn').addEventListener('click', () => {
        currentIndex = (currentIndex > 0) ? currentIndex - 1 : artworks.length - 1;
        updateDisplay();
      });
      document.getElementById('next-btn').addEventListener('click', () => {
        currentIndex = (currentIndex < artworks.length - 1) ? currentIndex + 1 : 0;
        updateDisplay();
      });

      // Fullscreen listeners
      mainImage.addEventListener('dblclick', enterFullscreen);
      closeFullscreenBtn.addEventListener('click', exitFullscreen);
      fullscreenOverlay.addEventListener('click', (event) => {
        if (event.target === fullscreenOverlay) {
          exitFullscreen();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === "Escape" && fullscreenOverlay.style.display === 'flex') {
          exitFullscreen();
        }
      });
    }
    
    document.addEventListener('DOMContentLoaded', initGallery);
</script>